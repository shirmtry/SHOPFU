<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üõí Premium Tools & Services</title>

    <!-- Fonts & icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --primary: #2b6ef6;
            --primary-dark: #244fd6;
            --muted: #6c757d;
            --bg: #f4f7fb;
            --card: #ffffff;
            --success: #16a34a;
            --danger: #ef4444;
            --radius: 14px;
            --shadow: 0 10px 30px rgba(18, 38, 63, 0.07);
            --glass: rgba(255,255,255,0.6);
            --transition: 260ms cubic-bezier(.2,.9,.3,1);
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            min-height:100%;
            font-family:'Poppins',system-ui,Arial;
            background:
                radial-gradient(1200px 400px at -10% -10%, rgba(43,110,246,0.06), transparent 12%),
                radial-gradient(800px 300px at 110% 110%, rgba(63,55,201,0.04), transparent 10%),
                var(--bg);
            color:#111827;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        header{
            padding:28px 20px;
            background: linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:#fff;
            text-align:center;
            font-family:'Montserrat',sans-serif;
            font-weight:700;
            font-size:20px;
            border-bottom-left-radius:18px;
            border-bottom-right-radius:18px;
            box-shadow:var(--shadow);
            position:relative;
            overflow:hidden;
        }
        header .brand{
            display:inline-flex;
            gap:12px;
            align-items:center;
        }
        header .brand i{font-size:22px; opacity:0.95}

        .container{
            max-width:1200px;
            margin:28px auto;
            padding:0 18px 80px;
        }

        .user-panel{
            display:flex;
            gap:18px;
            align-items:center;
            justify-content:space-between;
            background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.5));
            padding:18px;
            border-radius:12px;
            box-shadow:var(--shadow);
            backdrop-filter: blur(6px);
        }
        .user-left{display:flex;align-items:center;gap:14px}
        .user-avatar{
            width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;
            font-weight:700;color:#fff;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            box-shadow:0 6px 18px rgba(43,110,246,0.18); font-size:20px;
        }
        .user-info .name{font-weight:700;font-size:16px}
        .user-info .balance{color:var(--muted);margin-top:4px;display:flex;gap:8px;align-items:center}
        .user-info .balance .amount{color:var(--success);font-weight:700}

        .action-buttons{display:flex;gap:12px}
        .btn{
            padding:10px 16px;border-radius:999px;border:none;cursor:pointer;font-weight:600;
            box-shadow:0 6px 18px rgba(15,23,42,0.06);
            transition:transform var(--transition), box-shadow var(--transition);
            display:inline-flex;gap:10px;align-items:center;
        }
        .btn:active{transform:translateY(1px)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .btn-secondary{background:#fff;color:#111;border:1px solid rgba(15,23,42,0.06)}

        /* Shop grid */
        .shop-container{
            margin-top:22px;
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
            gap:20px;
        }

        .package-card{
            background:var(--card);
            border-radius:16px;
            overflow:hidden;
            box-shadow:var(--shadow);
            display:flex;
            flex-direction:column;
            transition:transform var(--transition), box-shadow var(--transition);
            min-height:300px;
        }
        .package-card:hover{transform:translateY(-8px); box-shadow:0 20px 50px rgba(2,6,23,0.08)}
        .package-header{
            padding:22px;text-align:center;color:#fff;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            position:relative;
        }
        .package-icon i{font-size:36px;opacity:0.95}
        .package-title{font-weight:800;margin-top:12px;font-size:18px}
        .package-body{padding:18px;display:flex;flex-direction:column;flex:1}
        .package-price{font-weight:800;font-size:22px;color:var(--danger);text-align:center}
        .price-period{font-size:13px;color:var(--muted);margin-top:6px;text-align:center}
        .package-features{margin-top:14px;flex:1}
        .feature-item{font-size:14px;color:#1f2937;margin:8px 0;padding-left:18px;position:relative}
        .feature-item::before{content:"";position:absolute;left:0;top:8px;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.15)}
        .package-footer{margin-top:18px}
        .btn-buy{
            width:100%;
            padding:14px 18px;border-radius:0 0 16px 16px;border:none;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:#fff;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
        }
        .btn-buy:hover{filter:brightness(.98);transform:translateY(-2px)}

        /* Loading */
        .loading-container{grid-column:1/-1;display:flex;align-items:center;justify-content:center;padding:36px}
        .spinner{
            width:56px;height:56px;border-radius:50%;border:6px solid rgba(15,23,42,0.06);border-top-color:var(--primary);
            animation:spin 1s linear infinite;
        }
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Notification */
        .notification{
            position:fixed;right:24px;top:24px;background:#fff;padding:14px 18px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,0.08);
            display:flex;gap:12px;align-items:flex-start;transform:translateX(110%);transition:transform 360ms cubic-bezier(.2,.9,.25,1);
            z-index:1200;max-width:380px;border-left:6px solid var(--success)
        }
        .notification.show{transform:translateX(0)}
        .notification .icon{font-size:22px;color:var(--success);flex-shrink:0}
        .notification h4{margin:0;font-size:15px}
        .notification p{margin:4px 0 0;color:var(--muted);font-size:13px}

        footer{padding:36px 18px;text-align:center;color:#6b7280;margin-top:40px;font-size:14px}
        .footer-links{display:flex;gap:18px;justify-content:center;flex-wrap:wrap;margin-bottom:16px}
        .footer-links a{color:inherit;text-decoration:none;display:inline-flex;gap:8px;align-items:center}

        /* Responsive */
        @media(max-width:720px){
            .user-panel{flex-direction:column;align-items:flex-start;gap:12px}
            .action-buttons{width:100%;justify-content:space-between}
        }
    </style>
</head>
<body>

<header>
    <div class="brand"><i class="fas fa-crown"></i> PREMIUM TOOLS &amp; SERVICES</div>
</header>

<main class="container">
    <section class="user-panel" aria-label="Th√¥ng tin ng∆∞·ªùi d√πng">
        <div class="user-left">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-info">
                <div class="name" id="username">ƒêang t·∫£i...</div>
                <div class="balance" aria-live="polite">
                    <i class="fas fa-wallet" style="color:var(--muted)"></i>
                    <div style="display:inline-block">S·ªë d∆∞: <span class="amount" id="balance">0</span> VND</div>
                </div>
            </div>
        </div>

        <div class="action-buttons" role="group" aria-label="Thao t√°c ng∆∞·ªùi d√πng">
            <button class="btn btn-primary" id="btn-deposit"><i class="fas fa-coins"></i> N·∫°p ti·ªÅn</button>
            <button class="btn btn-secondary" id="btn-logout"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</button>
        </div>
    </section>

    <section class="shop-container" id="shop" aria-label="G√≥i d·ªãch v·ª•">
        <div class="loading-container" id="loading">
            <div class="spinner" role="status" aria-hidden="true"></div>
        </div>
    </section>
</main>

<!-- Notification -->
<div class="notification" id="notification" role="status" aria-live="polite" aria-atomic="true">
    <div class="icon"><i class="fas fa-check-circle"></i></div>
    <div>
        <h4 id="notification-title">Th√†nh c√¥ng</h4>
        <p id="notification-message">Thao t√°c ƒë√£ ƒë∆∞·ª£c th·ª±c hi·ªán</p>
    </div>
</div>

<footer>
    <div class="footer-links">
        <a href="#" class="footer-link"><i class="fas fa-file-contract"></i> ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a>
        <a href="#" class="footer-link"><i class="fas fa-shield-alt"></i> Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
        <a href="#" class="footer-link"><i class="fas fa-headset"></i> H·ªó tr·ª£</a>
        <a href="#" class="footer-link"><i class="fas fa-envelope"></i> Li√™n h·ªá</a>
    </div>
    <div>&copy; 2025 Premium Tools &amp; Services. All rights reserved.</div>
</footer>

<script>
/*
  shop.html (fixed)
  Key fixes:
  - Added fallback when API fails to load
  - Improved error handling for API calls
  - Added local storage fallback for user data
  - Fixed authentication flow
*/

// Use a fallback API URL if the primary fails
const API_URL = "https://script.google.com/macros/s/AKfycby-wQER7OQWR2WYTRqwjhHXa7IrrW8V8IqhPBe3eJMpguEor1myIwoXs0HSIeDFt1elEg/exec";
const FALLBACK_API_URL = ""; // Add your fallback API URL here if needed

// DOM elements
const shopContainer = document.getElementById('shop');
const loadingEl = document.getElementById('loading');
const usernameElement = document.getElementById('username');
const balanceElement = document.getElementById('balance');
const userAvatarElement = document.getElementById('user-avatar');
const btnDeposit = document.getElementById('btn-deposit');
const btnLogout = document.getElementById('btn-logout');

const notification = document.getElementById('notification');
const notificationTitle = document.getElementById('notification-title');
const notificationMessage = document.getElementById('notification-message');
const notificationIcon = notification.querySelector('.icon i');

// User data with local storage fallback
let userData = { 
    name: localStorage.getItem('username') || 'Kh√°ch', 
    balance: Number(localStorage.getItem('balance')) || 0, 
    avatar: (localStorage.getItem('username') ? localStorage.getItem('username').charAt(0) : 'K').toUpperCase() 
};

// Product data (safe versions)
const packages = [
    {
        name: "G√≥i Basic",
        icon: "fas fa-laptop-code",
        price: 400000,
        code: "basic",
        period: "1 th√°ng",
        features: [
            "TOOL SEB b·∫£n c∆° b·∫£n",
            "S·ª≠ d·ª•ng 1 thi·∫øt b·ªã",
            "H·ªó tr·ª£ 24/7 qua chat",
            "C·∫≠p nh·∫≠t h√†ng tu·∫ßn",
            "B·∫£o h√†nh 7 ng√†y"
        ]
    },
    {
        name: "G√≥i VIP1",
        icon: "fas fa-rocket",
        price: 600000,
        code: "vip1",
        period: "3 th√°ng",
        features: [
            "TOOL EOS cao c·∫•p",
            "S·ª≠ d·ª•ng 1 thi·∫øt b·ªã",
            "Update mi·ªÖn ph√≠ li√™n t·ª•c",
            "H·ªó tr·ª£ t·ª´ xa",
            "B·∫£o h√†nh 30 ng√†y"
        ]
    },
    {
        name: "G√≥i VIP2",
        icon: "fas fa-bolt",
        price: 800000,
        code: "vip2",
        period: "6 th√°ng",
        features: [
            "TOOL EOS + SEB PRO",
            "D√πng ƒë∆∞·ª£c 1 k√¨ h·ªçc",
            "H·ªó tr·ª£ t·ª´ xa 24/7",
            "∆Øu ti√™n c·∫≠p nh·∫≠t",
            "B·∫£o h√†nh 60 ng√†y"
        ]
    },
    {
        name: "G√≥i VIP3",
        icon: "fas fa-crown",
        price: 3000000,
        code: "vip3",
        period: "4 nƒÉm",
        features: [
            "TOOL EOS + SEB PRO MAX",
            "D√πng ƒë∆∞·ª£c 4 nƒÉm",
            "H·ªó tr·ª£ VIP 24/7",
            "C·∫≠p nh·∫≠t real-time",
            "B·∫£o h√†nh tr·ªçn ƒë·ªùi"
        ]
    },
    {
        name: "G√≥i Support",
        icon: "fas fa-hands-helping",
        price: 50000,
        code: "support",
        period: "1 l·∫ßn",
        features: [
            "H·ªó tr·ª£ k·ªπ thu·∫≠t chuy√™n s√¢u",
            "C√†i ƒë·∫∑t tool t·ª´ xa",
            "T∆∞ v·∫•n t·ªëi ∆∞u b·∫£o m·∫≠t",
            "Fix l·ªói nhanh ch√≥ng",
            "H∆∞·ªõng d·∫´n chi ti·∫øt"
        ]
    },
    {
        name: "Banking Demo (Ch·ªâ demo)",
        icon: "fas fa-university",
        price: 50000,
        code: "banking_demo",
        period: "Vƒ©nh vi·ªÖn (demo)",
        features: [
            "Giao di·ªán gi·∫£ l·∫≠p cho m·ª•c ƒë√≠ch h·ªçc t·∫≠p / demo",
            "Kh√¥ng d√πng cho giao d·ªãch th·ª±c t·∫ø",
            "M√¥ ph·ªèng chuy·ªÉn kho·∫£n - ch·ªâ test",
            "Kh√¥ng l∆∞u th√¥ng tin nh·∫°y c·∫£m",
            "H·ªó tr·ª£ k·ªπ thu·∫≠t"
        ]
    },
    {
        name: "G√≥i B·∫£o M·∫≠t",
        icon: "fas fa-shield-alt",
        price: 250000,
        code: "security",
        period: "6 th√°ng",
        features: [
            "Ch·ªëng b·ªã ph√°t hi·ªán tool",
            "·∫®n IP v√† th√¥ng tin thi·∫øt b·ªã",
            "C·∫≠p nh·∫≠t li√™n t·ª•c",
            "B·∫£o v·ªá real-time",
            "H·ªó tr·ª£ 24/7"
        ]
    }
];

// ---------- Initialization ----------
document.addEventListener('DOMContentLoaded', async () => {
    // First update UI with local data
    updateUserUI();
    
    // Then check auth and load data
    const authValid = await checkAuth();
    if (!authValid) return;
    
    await loadUserData();
    renderShop();
    setupEventListeners();
});

// ---------- Auth & Data ----------
async function checkAuth(){
    const username = localStorage.getItem('username');
    const token = localStorage.getItem('authToken');

    if (!username || !token){
        showNotification('error', 'Y√™u c·∫ßu ƒëƒÉng nh·∫≠p', 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c');
        setTimeout(()=>{ window.location.href = 'index.html'; }, 1600);
        return false;
    }

    try {
        // Try primary API first
        const resp = await fetchWithTimeout(`${API_URL}?action=verifyToken&username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`, {
            cache: 'no-store',
            timeout: 5000
        });
        
        const data = await resp.json();
        if (!data.success) {
            // If primary API fails, try fallback if available
            if (FALLBACK_API_URL) {
                const fallbackResp = await fetchWithTimeout(`${FALLBACK_API_URL}?action=verifyToken&username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`, {
                    cache: 'no-store',
                    timeout: 5000
                });
                const fallbackData = await fallbackResp.json();
                if (!fallbackData.success) throw new Error('Token kh√¥ng h·ª£p l·ªá');
                return true;
            }
            throw new Error('Token kh√¥ng h·ª£p l·ªá');
        }
        return true;
    } catch (err) {
        console.error('L·ªói x√°c th·ª±c', err);
        // Allow user to continue with local data if API fails
        showNotification('warning', 'C·∫£nh b√°o k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server, s·ª≠ d·ª•ng d·ªØ li·ªáu t·∫°m');
        return true; // Changed to true to allow proceeding with local data
    }
}

// Helper function for fetch with timeout
function fetchWithTimeout(url, options = {}) {
    const { timeout = 8000, ...fetchOptions } = options;
    
    return Promise.race([
        fetch(url, fetchOptions),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Request timeout')), timeout)
        )
    ]);
}

async function loadUserData(){
    const username = localStorage.getItem('username') || 'Kh√°ch';
    
    try {
        const resp = await fetchWithTimeout(`${API_URL}?action=getUser&username=${encodeURIComponent(username)}`, {
            cache: 'no-store',
            timeout: 5000
        });
        
        if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server');
        const data = await resp.json();

        if (data.success){
            userData = {
                name: data.name || username,
                balance: Number(data.balance) || 0,
                avatar: (data.name ? data.name.charAt(0) : username.charAt(0)).toUpperCase()
            };
            // Save to local storage as fallback
            localStorage.setItem('balance', userData.balance);
        } else {
            // Use local data if API fails
            console.warn('API tr·∫£ v·ªÅ l·ªói:', data.message);
        }
    } catch (err) {
        console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err);
        // Use local data if API fails
        showNotification('warning', 'C·∫£nh b√°o k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu m·ªõi, s·ª≠ d·ª•ng d·ªØ li·ªáu t·∫°m');
    } finally {
        updateUserUI();
    }
}

// ---------- UI Updates ----------
function updateUserUI(){
    usernameElement.textContent = userData.name;
    balanceElement.textContent = userData.balance.toLocaleString('vi-VN');
    userAvatarElement.textContent = userData.avatar;
}

// ---------- Render shop ----------
function renderShop(){
    // Remove loading
    if (loadingEl) loadingEl.remove();

    shopContainer.innerHTML = '';

    if (!packages || packages.length === 0){
        shopContainer.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:36px;color:var(--muted)">
                <i class="fas fa-box-open" style="font-size:40px;margin-bottom:10px;display:block"></i>
                <div>Hi·ªán kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</div>
            </div>
        `;
        return;
    }

    packages.forEach(pkg => {
        const featuresHtml = pkg.features.map(f => `<div class="feature-item">${escapeHtml(f)}</div>`).join('');
        const card = document.createElement('div');
        card.className = 'package-card';
        card.innerHTML = `
            <div class="package-header">
                <div class="package-icon"><i class="${pkg.icon}"></i></div>
                <div class="package-title">${escapeHtml(pkg.name)}</div>
            </div>
            <div class="package-body">
                <div class="package-price">${pkg.price.toLocaleString('vi-VN')} VND</div>
                <div class="price-period">${escapeHtml(pkg.period)}</div>
                <div class="package-features">${featuresHtml}</div>
                <div class="package-footer"><button class="btn-buy" data-price="${pkg.price}" data-package="${encodeURIComponent(pkg.code)}"><i class="fas fa-shopping-cart"></i> Mua ngay</button></div>
            </div>
        `;
        shopContainer.appendChild(card);
    });

    // Attach listeners
    document.querySelectorAll('.btn-buy').forEach(btn => btn.addEventListener('click', handleBuyClick));
}

// ---------- Buy logic ----------
function handleBuyClick(e){
    const btn = e.currentTarget;
    const price = Number(btn.getAttribute('data-price') || 0);
    const packageCode = decodeURIComponent(btn.getAttribute('data-package') || '');
    const pkg = packages.find(p => p.code === packageCode);
    const packageName = pkg ? pkg.name : 's·∫£n ph·∫©m';

    // If user has enough balance -> redirect to thankyou (simulate purchase)
    if (userData.balance >= price){
        showNotification('success', 'Giao d·ªãch th√†nh c√¥ng', `B·∫°n ƒë√£ mua ${packageName}`);
        // In a real app, you would call an API to process the purchase here
        setTimeout(()=> {
            window.location.href = `thankyou.html?package=${encodeURIComponent(packageCode)}&price=${price}`;
        }, 700);
    } else {
        const need = price - userData.balance;
        showNotification('error', 'Thi·∫øu s·ªë d∆∞', `B·∫°n c·∫ßn n·∫°p th√™m ${need.toLocaleString('vi-VN')} VND`);
        setTimeout(()=> {
            window.location.href = `banking.html?package=${encodeURIComponent(packageCode)}&amount=${need}`;
        }, 900);
    }
}

// ---------- Notifications ----------
let notifTimer = null;
function showNotification(type='success', title='Th√¥ng b√°o', message=''){
    // set border color & icon
    notification.className = 'notification';
    notification.classList.add('show');

    if (type === 'success') {
        notification.style.borderLeftColor = 'var(--success)';
        notificationIcon.className = 'fas fa-check-circle';
        notificationIcon.style.color = '';
    } else if (type === 'error') {
        notification.style.borderLeftColor = 'var(--danger)';
        notificationIcon.className = 'fas fa-exclamation-circle';
        notificationIcon.style.color = '';
    } else if (type === 'warning') {
        notification.style.borderLeftColor = 'orange';
        notificationIcon.className = 'fas fa-exclamation-triangle';
        notificationIcon.style.color = 'orange';
    }

    notificationTitle.textContent = title;
    notificationMessage.textContent = message;

    if (notifTimer) clearTimeout(notifTimer);
    notifTimer = setTimeout(()=> {
        notification.classList.remove('show');
    }, 5000);
}

// ---------- Setup other event listeners ----------
function setupEventListeners(){
    btnDeposit.addEventListener('click', ()=> {
        window.location.href = 'banking.html';
    });

    btnLogout.addEventListener('click', ()=> {
        localStorage.removeItem('username');
        localStorage.removeItem('authToken');
        localStorage.removeItem('balance');
        showNotification('success','ƒêƒÉng xu·∫•t','B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng');
        setTimeout(()=> window.location.href = 'index.html', 900);
    });
}

// ---------- Utilities ----------
function escapeHtml(str){
    if (!str) return '';
    return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
}
</script>
</body>
</html>
