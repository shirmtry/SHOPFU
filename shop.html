<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOOL Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color:#4361ee; --secondary-color:#3a0ca3; --accent-color:#f72585;
      --dark-color:#212529; --light-color:#f8f9fa; --success-color:#4cc9f0;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Montserrat',sans-serif;
      background:linear-gradient(135deg,#000428,#004e92);
      margin:0; padding:0; min-height:100vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:var(--light-color);
    }
    .main-container{width:90%;max-width:900px;margin:2rem auto}
    .header{text-align:center;margin-bottom:2rem}
    .header h1{
      font-size:2.5rem;margin:0;
      background:linear-gradient(to right,#f72585,#4361ee);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .user-info{
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,0.1);padding:1rem;border-radius:10px;
      margin-bottom:1.5rem;backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.2)
    }
    .user-greeting{font-size:1.1rem;font-weight:600}
    .user-greeting span{color:var(--accent-color)}
    .user-balance{background:rgba(0,0,0,0.3);padding:.5rem 1rem;border-radius:20px;font-weight:700}

    .products-container{
      background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);
      border-radius:15px;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.2)
    }
    .section-title{font-size:1.4rem;margin-bottom:1.5rem;display:flex;align-items:center}
    .section-title i{margin-right:10px;color:var(--accent-color)}
    .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.25rem}
    .product-card{
      background:linear-gradient(145deg,rgba(255,255,255,0.15),rgba(255,255,255,0.05));
      border-radius:14px;padding:1.25rem;transition:.25s;border:1px solid rgba(255,255,255,0.12);
      position:relative;overflow:hidden
    }
    .product-card:hover{transform:translateY(-6px);box-shadow:0 12px 22px rgba(0,0,0,.25);border-color:rgba(255,255,255,.28)}
    .product-card::before{
      content:'';position:absolute;inset:0;background:linear-gradient(45deg,transparent,rgba(255,255,255,.06),transparent)
    }
    .product-name{font-size:1.15rem;font-weight:800;margin:0;color:#fff}
    .product-features{list-style:none;padding:0;margin:1rem 0 .75rem;font-size:.92rem}
    .product-features li{margin:.35rem 0;display:flex;align-items:center}
    .product-features li::before{content:'✓';color:var(--success-color);margin-right:8px;font-weight:900}
    .product-price{font-size:1.5rem;font-weight:800;margin:1rem 0 1.1rem;text-align:center;color:var(--accent-color)}
    .btn-select{
      width:100%;padding:12px;border:none;border-radius:10px;
      background:linear-gradient(to right,var(--primary-color),var(--secondary-color));
      color:#fff;font-weight:700;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center
    }
    .btn-select i{margin-right:8px}
    .btn-select:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(67,97,238,.45)}
    .btn-select:disabled{opacity:.6;cursor:not-allowed}

    .note-box{
      background:rgba(255,255,255,.1);backdrop-filter:blur(10px);
      border-radius:10px;padding:1.25rem;margin-top:1.25rem;text-align:center;font-size:.95rem;
      border:1px solid rgba(255,255,255,.2)
    }

    /* Banner chờ admin cộng tiền */
    .waiting-banner{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:22px;background:rgba(0,0,0,.85);color:#fff;border:1px solid rgba(255,255,255,.2);
      border-radius:12px;padding:12px 16px;display:none;align-items:center;gap:10px;z-index:9999
    }
    .waiting-banner.show{display:flex}
    .waiting-banner .dot{width:8px;height:8px;border-radius:50%;background:#20c997;box-shadow:0 0 8px #20c997}
    .waiting-banner .txt small{opacity:.85}
    .waiting-banner .act{margin-left:10px;font-weight:700;opacity:.9}

    @media (max-width:768px){.main-container{width:95%}.product-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="main-container">
    <div class="header"><h1>PREMIUM TOOL SHOP</h1></div>

    <div class="user-info" id="user-info">
      <div class="user-greeting" id="user-greeting">Đang tải...</div>
      <div class="user-balance" id="user-balance"><i class="fas fa-wallet"></i> Đang tải...</div>
    </div>

    <div class="products-container">
      <h2 class="section-title"><i class="fas fa-crown"></i> GÓI DỊCH VỤ CAO CẤP</h2>

      <div class="product-grid">
        <div class="product-card">
          <h3 class="product-name">TOOL SEB</h3>
          <ul class="product-features">
            <li>Auto chụp</li><li>Auto giải</li><li>Auto khoanh</li><li>Hỗ trợ 24/7</li>
          </ul>
          <div class="product-price">400.000 VND</div>
          <button class="btn-select" data-name="Gói Basic" data-price="400000"><i class="fas fa-shopping-cart"></i> Gói Basic</button>
        </div>

        <div class="product-card">
          <h3 class="product-name">TOOL EOS</h3>
          <ul class="product-features">
            <li>Auto chụp</li><li>Auto giải</li><li>Auto khoanh</li><li>Hỗ trợ 24/7</li>
          </ul>
          <div class="product-price">600.000 VND</div>
          <button class="btn-select" data-name="Gói VIP1" data-price="600000"><i class="fas fa-shopping-cart"></i> Gói VIP1</button>
        </div>

        <div class="product-card">
          <h3 class="product-name">TOOL EOS + SEB</h3>
          <ul class="product-features">
            <li>Auto chụp</li><li>Auto giải</li><li>Auto khoanh</li><li>Bản quyền 1 kì</li>
          </ul>
          <div class="product-price">800.000 VND</div>
          <button class="btn-select" data-name="Gói VIP2" data-price="800000"><i class="fas fa-gem"></i> GÓI VIP2</button>
        </div>

        <div class="product-card">
          <h3 class="product-name">TOOL EOS + SEB</h3>
          <ul class="product-features">
            <li>Tất cả tính năng EOS & SEB</li><li>Tính năng độc quyền</li><li>Hỗ trợ VIP 1-1</li><li>Bản quyền vĩnh viễn</li>
          </ul>
          <div class="product-price">3.000.000 VND</div>
          <button class="btn-select" data-name="Gói VIP3" data-price="3000000"><i class="fas fa-gem"></i> GÓI VIP3</button>
        </div>
      </div>
    </div>

    <div class="note-box">
      <p>Sau khi chọn gói, hệ thống sẽ <b>tự kiểm tra số dư</b>. Nếu admin đã cộng đủ, trang sẽ <b>tự chuyển sang Thank You</b> (không cần qua Banking).</p>
    </div>
  </div>

  <!-- Banner chờ admin cộng tiền -->
  <div id="waitingBanner" class="waiting-banner">
    <div class="dot"></div>
    <div class="txt">
      <div><b>Đang chờ admin cộng tiền...</b></div>
      <small id="wb-detail">Yêu cầu: 0 VND</small>
    </div>
    <div class="act" id="wb-balance"></div>
  </div>

  <!-- ===== API / USER ===== -->
  <script>
    // Bắt buộc có username trong localStorage
    const username = localStorage.getItem("username");
    if (!username) window.location.href = "login.html";

    const apiLink = 'https://script.google.com/macros/s/AKfycby1nG2mJDN0XQ5A4BEYT0HGk-SQiGkRnYV7dWLAbJgioFEKDs5gm3pGICLJqGpVTRuDpw/exec';

    let CURRENT_BALANCE = 0;
    let BALANCE_REFRESH_TIMER = null;

    async function fetchUser() {
      const res = await fetch(apiLink + '?action=getUser&username=' + encodeURIComponent(username));
      return res.json();
    }

    async function refreshUserInfo() {
      try {
        const data = await fetchUser();
        if (data.error) {
          document.getElementById('user-greeting').innerHTML = `<span style="color:#ffb3b3">${data.error}</span>`;
          document.getElementById('user-balance').innerHTML = '';
          return;
        }
        CURRENT_BALANCE = Number(data.balance || 0);
        document.getElementById('user-greeting').innerHTML = `Xin chào, <span>${data.username}</span>!`;
        document.getElementById('user-balance').innerHTML = `<i class="fas fa-wallet"></i> Số dư: ${CURRENT_BALANCE.toLocaleString('vi-VN')} VND`;
      } catch (e) {
        document.getElementById('user-greeting').innerHTML = `<span style="color:#ffb3b3">Lỗi kết nối API</span>`;
        document.getElementById('user-balance').innerHTML = '';
      }
    }

    // Tự làm mới số dư 10s/lần
    async function startAutoRefreshBalance() {
      await refreshUserInfo();
      if (BALANCE_REFRESH_TIMER) clearInterval(BALANCE_REFRESH_TIMER);
      BALANCE_REFRESH_TIMER = setInterval(refreshUserInfo, 10000);
    }
    startAutoRefreshBalance();
  </script>

  <!-- ===== CHỌN GÓI & POLL SỐ DƯ ===== -->
  <script>
    let POLL_TIMER = null;
    let SELECTED = null;

    function setWaitingBanner(show, need = 0) {
      const el = document.getElementById('waitingBanner');
      if (show) {
        el.classList.add('show');
        document.getElementById('wb-detail').textContent =
          `Yêu cầu: ${Number(need).toLocaleString('vi-VN')} VND`;
        document.getElementById('wb-balance').textContent =
          `Số dư: ${Number(CURRENT_BALANCE).toLocaleString('vi-VN')} VND`;
      } else {
        el.classList.remove('show');
      }
    }

    function lockButton(btn, locking) {
      if (!btn) return;
      if (locking) {
        btn.dataset._orig = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ĐANG CHỜ XỬ LÝ...';
        btn.disabled = true;
      } else {
        btn.innerHTML = btn.dataset._orig || btn.innerHTML;
        btn.disabled = false;
      }
    }

    async function checkAndRedirect() {
      // Đủ tiền ⇒ ghi order + chuyển thankyou
      if (!SELECTED) return;
      if (CURRENT_BALANCE >= SELECTED.price) {
        const order = {
          name: SELECTED.displayName,                          // tên gói hiển thị (Gói VIP2, ...)
          price: SELECTED.price,
          formattedPrice: `${SELECTED.price.toLocaleString('vi-VN')} VND`,
          productTitle: SELECTED.productTitle                  // tên sản phẩm (TOOL EOS + SEB, ...)
        };
        const meta = {
          // không cần orderCode trong kịch bản này
          orderTime: new Date().toLocaleString('vi-VN')
        };
        localStorage.setItem('currentOrder', JSON.stringify(order));
        localStorage.setItem('currentOrderMeta', JSON.stringify(meta));

        // Truyền thêm qua query để thankyou đọc nhanh (nếu muốn)
        const qp = new URLSearchParams({
          product: `${order.productTitle} — ${order.name}`,
          price: order.formattedPrice,
          time: meta.orderTime
        }).toString();

        window.location.href = `thankyou.html?${qp}`;
        return true;
      }
      return false;
    }

    async function pollBalanceLoop(btn) {
      // Cập nhật số dư mỗi vòng (song song với auto refresh 10s)
      try {
        const data = await fetchUser();
        if (!data.error) {
          CURRENT_BALANCE = Number(data.balance || 0);
          document.getElementById('user-balance').innerHTML =
            `<i class="fas fa-wallet"></i> Số dư: ${CURRENT_BALANCE.toLocaleString('vi-VN')} VND`;
          // cập nhật banner
          setWaitingBanner(true, SELECTED.price);
        }
      } catch {}

      if (await checkAndRedirect()) {
        clearInterval(POLL_TIMER);
        lockButton(btn, false);
        setWaitingBanner(false);
        return;
      }

      // lặp lại sau 3s
    }

    // Gắn sự kiện cho 4 nút chọn gói
    document.querySelectorAll('.btn-select').forEach(btn => {
      btn.addEventListener('click', async function () {
        const productTitle = this.closest('.product-card').querySelector('.product-name').textContent.trim();
        const displayName  = this.dataset.name || this.textContent.trim();
        const price        = Number(this.dataset.price || 0);

        SELECTED = { productTitle, displayName, price };
        lockButton(this, true);

        // Hiện banner chờ
        setWaitingBanner(true, price);

        // Kiểm tra ngay 1 lần trước khi poll
        await refreshUserInfo();
        if (await checkAndRedirect()) return;

        // Bắt đầu poll 3s/lần
        if (POLL_TIMER) clearInterval(POLL_TIMER);
        POLL_TIMER = setInterval(() => pollBalanceLoop(this), 3000);
      });
    });
  </script>

  <!-- ===== Random notify (giữ nguyên) ===== -->
  <script>
    const NAMES=["Nguyễn Văn An","Nguyễn Văn Bình","Nguyễn Văn Cường","Nguyễn Văn Dũng","Nguyễn Văn Đức","Nguyễn Văn Hùng","Nguyễn Văn Khánh","Nguyễn Văn Lâm","Nguyễn Văn Long","Nguyễn Văn Minh","Nguyễn Văn Nam","Nguyễn Văn Phát","Nguyễn Văn Phú","Nguyễn Văn Quân","Nguyễn Văn Quang","Nguyễn Văn Sơn","Nguyễn Văn Tài","Nguyễn Văn Thắng","Nguyễn Văn Thành","Nguyễn Văn Toàn","Nguyễn Văn Trung","Nguyễn Văn Tuấn","Nguyễn Văn Vinh","Nguyễn Văn Vũ","Nguyễn Văn Việt","Nguyễn Văn Hòa","Nguyễn Văn Kiên","Nguyễn Văn Đạt","Nguyễn Văn Hiếu","Nguyễn Văn Hiệp","Nguyễn Văn Hải","Nguyễn Văn Thái","Nguyễn Văn Hạnh","Nguyễn Văn Hảo","Nguyễn Văn Bảo","Nguyễn Văn Phúc","Nguyễn Văn Khoa","Nguyễn Văn Lộc","Nguyễn Văn Thọ","Nguyễn Văn Thành","Nguyễn Thị An","Nguyễn Thị Bình","Nguyễn Thị Cúc","Nguyễn Thị Dung","Nguyễn Thị Đào","Nguyễn Thị Hạnh","Nguyễn Thị Hằng","Nguyễn Thị Hoa","Nguyễn Thị Hồng","Nguyễn Thị Huệ","Nguyễn Thị Lan","Nguyễn Thị Lý","Nguyễn Thị Mai","Nguyễn Thị Nga","Nguyễn Thị Ngọc","Nguyễn Thị Nhàn","Nguyễn Thị Nhung","Nguyễn Thị Phương","Nguyễn Thị Quỳnh","Nguyễn Thị Thảo","Nguyễn Thị Thu","Nguyễn Thị Thủy","Nguyễn Thị Tuyết","Nguyễn Thị Vân","Nguyễn Thị Yến","Nguyễn Thị Hương","Nguyễn Thị Tâm","Nguyễn Thị Thanh","Nguyễn Thị Trinh","Nguyễn Thị Trúc","Trần Văn An","Trần Văn Bình","Trần Văn Cường","Trần Văn Dũng","Trần Văn Đức","Trần Văn Hùng","Trần Văn Khánh","Trần Văn Lâm","Trần Văn Long","Trần Văn Minh","Trần Văn Nam","Trần Văn Phát","Trần Văn Quân","Trần Văn Quang","Trần Văn Sơn","Trần Văn Tài","Trần Văn Thắng","Trần Văn Toàn","Trần Văn Trung","Trần Văn Tuấn","Trần Văn Vinh","Trần Văn Vũ","Trần Văn Việt","Trần Văn Hòa","Trần Văn Kiên","Trần Văn Đạt","Trần Văn Hiếu","Trần Văn Hiệp","Trần Văn Hải","Trần Văn Thái","Trần Văn Hạnh","Trần Văn Hảo","Trần Văn Bảo","Trần Văn Phúc","Trần Văn Khoa","Trần Văn Lộc","Trần Văn Thọ","Trần Văn Thành","Trần Thị An","Trần Thị Bình","Trần Thị Cúc","Trần Thị Dung","Trần Thị Đào","Trần Thị Hạnh","Trần Thị Hằng","Trần Thị Hoa","Trần Thị Hồng","Trần Thị Huệ","Trần Thị Lan","Trần Thị Lý","Trần Thị Mai","Trần Thị Nga","Trần Thị Ngọc","Trần Thị Nhàn","Trần Thị Nhung","Trần Thị Phương","Trần Thị Quỳnh","Trần Thị Thảo","Trần Thị Thu","Trần Thị Thủy","Trần Thị Tuyết","Trần Thị Vân","Trần Thị Yến","Trần Thị Hương","Trần Thị Tâm","Trần Thị Thanh","Trần Thị Trinh","Trần Thị Trúc"];
    const PROVINCES=["Hà Nội","TP.HCM","Đà Nẵng","Gia Lai","Cần Thơ"];
    const PRODUCTS=[{name:"Gói Basic",price:"400.000 VND"},{name:"Gói VIP1",price:"600.000 VND"},{name:"Gói VIP2",price:"800.000 VND"},{name:"Gói VIP3",price:"3.000.000 VND"}];
    const r=i=>i[Math.floor(Math.random()*i.length)];
    function notifyHTML(){
      const name=r(NAMES),province=r(PROVINCES),prod=r(PRODUCTS);
      return `<div style="display:flex;align-items:center;background:rgba(0,0,0,.85);color:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.2);padding:12px 20px 12px 12px;position:fixed;left:20px;bottom:30px;z-index:9999;min-width:260px;font-size:1rem;">
        <i class="fa-solid fa-bell" style="color:#f72585;font-size:1.4rem;margin-right:12px"></i>
        <div><b>${name}</b> (${province}) vừa mua <span style="color:#4cc9f0;font-weight:600">${prod.name}</span><br><span style="font-size:.95em;">Giá: <b>${prod.price}</b></span></div>
      </div>`
    }
    function showNotify(){
      const wrap=document.createElement('div');wrap.innerHTML=notifyHTML();document.body.appendChild(wrap);
      setTimeout(()=>{wrap.style.transition='opacity .6s';wrap.style.opacity=0;setTimeout(()=>wrap.remove(),600)},6000)
    }
    (function startRandomNotify(t=30000){
      setTimeout(function loop(){showNotify();setTimeout(loop,t+Math.floor(Math.random()*4000)-2000)},2000+Math.random()*2000)
    })();
  </script>

  <!-- ===== Anti view-source (giữ nguyên) ===== -->
  <script>
    (function(){
      document.addEventListener('contextmenu',e=>{e.preventDefault();return false},{capture:true,passive:false});
      ['selectstart','dragstart','copy','cut'].forEach(ev=>document.addEventListener(ev,e=>e.preventDefault(),{capture:true}));
      window.addEventListener('keydown',function(e){
        if(e.key==='F12') return e.preventDefault();
        if(e.ctrlKey&&e.shiftKey&&['I','J','C'].includes(e.key.toUpperCase())) return e.preventDefault();
        if(e.ctrlKey&&!e.shiftKey&&e.key.toUpperCase()==='U') return e.preventDefault();
        if(e.ctrlKey&&['S','P'].includes(e.key.toUpperCase())) return e.preventDefault();
      },{capture:true});
      var open=false, img=new Image();
      Object.defineProperty(img,'id',{get:function(){open=true;return ''}});
      setInterval(function(){
        open=false; console.log(img);
        const ovId='devtools-overlay';
        if(open){
          if(!document.getElementById(ovId)){
            const ov=document.createElement('div');
            ov.id=ovId; ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;z-index:99999;display:flex;align-items:center;justify-content:center;font-size:20px';
            ov.textContent='DevTools detected — trang bị giới hạn tạm thời.'; document.body.appendChild(ov);
          }
        }else{const o=document.getElementById(ovId); if(o) o.remove();}
      },1000);
    })();
  </script>
</body>
</html>
